name: Run Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Run every Monday at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering
  workflow_call:  # Allow calling from other workflows

permissions:
  contents: read

jobs:
  # Path detection only used for PRs - on main push we run everything
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      run-all: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' }}
      license-utility-changed: ${{ steps.changes.outputs.license-utility }}
      repo-breakdown-changed: ${{ steps.changes.outputs.repo-breakdown }}
      vm-extract-changed: ${{ steps.changes.outputs.vm-extract }}
      repo-delete-utility-changed: ${{ steps.changes.outputs.repo-delete-utility }}
      image-cleanup-utility-changed: ${{ steps.changes.outputs.image-cleanup-utility }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          license-utility:
            - 'examples/license-utility/**'
            - 'aquasec/**'
          repo-breakdown:
            - 'examples/repo-breakdown/**'
            - 'aquasec/**'
          vm-extract:
            - 'examples/vm-extract/**'
            - 'aquasec/**'
          repo-delete-utility:
            - 'examples/repo-delete-utility/**'
            - 'aquasec/**'
          image-cleanup-utility:
            - 'examples/image-cleanup-utility/**'
            - 'aquasec/**'

  test-library:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run library tests
      run: |
        python -m pytest tests/ -v --tb=short

    - name: Upload coverage reports
      if: matrix.python-version == '3.9'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  test-license-utility:
    needs: detect-changes
    if: needs.detect-changes.outputs.run-all == 'true' || needs.detect-changes.outputs.license-utility-changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install library in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install example dependencies
      run: |
        cd examples/license-utility
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run license utility tests
      run: |
        cd examples/license-utility
        python -m pytest tests/ -v --tb=short

    - name: Test license utility CLI
      run: |
        cd examples/license-utility
        python aqua_license_util.py --help

  test-repo-breakdown:
    needs: detect-changes
    if: needs.detect-changes.outputs.run-all == 'true' || needs.detect-changes.outputs.repo-breakdown-changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install library in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install example dependencies
      run: |
        cd examples/repo-breakdown
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run repo breakdown tests
      run: |
        cd examples/repo-breakdown
        python -m pytest tests/ -v --tb=short

    - name: Test repo breakdown CLI
      run: |
        cd examples/repo-breakdown
        python aqua_repo_breakdown.py --help

  test-vm-extract:
    needs: detect-changes
    if: needs.detect-changes.outputs.run-all == 'true' || needs.detect-changes.outputs.vm-extract-changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install library in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install example dependencies
      run: |
        cd examples/vm-extract
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run vm extract tests
      run: |
        cd examples/vm-extract
        python -m pytest tests/ -v --tb=short --continue-on-collection-errors

    - name: Test vm extract CLI
      run: |
        cd examples/vm-extract
        python aqua_vm_extract.py --help

  test-repo-delete-utility:
    needs: detect-changes
    if: needs.detect-changes.outputs.run-all == 'true' || needs.detect-changes.outputs.repo-delete-utility-changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install library in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install example dependencies
      run: |
        cd examples/repo-delete-utility
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run repo delete utility tests
      run: |
        cd examples/repo-delete-utility
        python -m pytest tests/ -v --tb=short

    - name: Test repo delete utility CLI
      run: |
        cd examples/repo-delete-utility
        python aqua_repo_delete.py --help

  test-image-cleanup-utility:
    needs: detect-changes
    if: needs.detect-changes.outputs.run-all == 'true' || needs.detect-changes.outputs.image-cleanup-utility-changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install library in development mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Install example dependencies
      run: |
        cd examples/image-cleanup-utility
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run image delete utility tests
      run: |
        cd examples/image-cleanup-utility
        python -m pytest tests/ -v --tb=short

    - name: Test image delete utility CLI
      run: |
        cd examples/image-cleanup-utility
        python aqua_image_cleanup.py --help
